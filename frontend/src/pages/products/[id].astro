---
import { Image } from "astro:assets";
import PrevNext from "../../components/PrevNext.astro";
import BaseLayout from "../../layouts/BaseLayout.astro";
import fetchApi from "../../wrapper/strapi.js";

type ImageType = {
  url: string;
  formats?: {
    small?: { url: string };
    thumbnail?: { url: string };
  };
};

type CategoryType = {
  name: string;
  slug: string;
};

type ProductType = {
  documentId: string;
  title: string;
  description: string;
  price: number;
  rating: number;
  image?: ImageType[];
  category?: CategoryType;
};

export async function getStaticPaths() {
  const products = await fetchApi({
    endpoint: "products",
    wrappedByKey: "data",
    query: { populate: ["image", "category"] },
  });

  const paths = products.map((product, i) => ({
    params: { id: product.documentId },
    props: {
      product,
      next: i < products.length - 1 ? products[i + 1] : null,
      prev: i > 0 ? products[i - 1] : null,
    },
  }));

  return paths;
}

const { product, prev, next } = Astro.props as {
  product: ProductType;
  prev: ProductType | null;
  next: ProductType | null;
};

const img = Array.isArray(product.image) ? product.image[0] : null;
const rel =
  img?.formats?.small?.url ?? img?.formats?.thumbnail?.url ?? img?.url ?? null;
const src = rel ? import.meta.env.STRAPI_URL + rel : null;
---

<BaseLayout pageTitle={product.title}>
  <div class="wrapper" transition:name={`product-${product.documentId}`}>
    {
      src && (
        <Image
          src={src}
          alt="Product image"
          inferSize
          layout="constrained"
          format="avif"
          widths={[362, 724, 920, 1086]}
          sizes="(min-width: 1120px) 362px, calc(34.88vw - 22px)"
        />
      )
    }

    <h3>{product.title}</h3>

    <p class="description">{product.description}</p>

    {
      product.category && (
        <p class="category">
          <a href={`/categories/${product.category.slug}`}>
            More {product.category.name}
          </a>
        </p>
      )
    }

    <p class="price">
      &euro; <span>{product.price}</span>
    </p>
    <button>Buy now</button>
  </div>
  <PrevNext prev={prev} next={next} path="products" />
</BaseLayout>

<style>
  /* keep your teacherâ€™s wrapper styles here */
</style>
